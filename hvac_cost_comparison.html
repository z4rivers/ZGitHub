<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heat Pump - Furnace - Hybrid</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .emissions-toggle {
            position: absolute;
            top: 10px;
            right: 12px;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .emissions-toggle input { transform: scale(0.9); }

        .main-content {
            padding: 20px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .control-group h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .info-icon {
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        /* Inline info dot next to labels */
        .info-dot {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: #6c757d;
            color: #ffffff;
            border-radius: 50%;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 6px;
            vertical-align: text-top;
            position: relative;
            top: -1px;
        }

        .info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .input-field {
            flex: 1;
        }

        .input-field label {
            display: block;
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .input-field input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            background: white;
        }

        .input-field input:focus {
            outline: none;
            border-color: #007bff;
        }

        .location-info {
            margin-top: 15px;
            font-size: 0.8rem;
        }

        .location-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 2px;
        }

        .data-source {
            color: #059669;
            font-style: italic;
            font-weight: 600;
            background: rgba(16, 185, 129, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border-left: 3px solid #10b981;
        }

        /* Comic Style Tooltips */
        [title], [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [title]:hover::after {
            content: attr(title);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: white;
            padding: 20px 24px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 680px;
            max-width: 90vw;
            white-space: normal;
            text-align: left;
            line-height: 1.5;
            overflow-wrap: anywhere;
            pointer-events: none;
            border: 3px solid #ff5252;
            animation: bubblePop 0.3s ease-out;
            margin-top: 10px;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #ff6b6b;
            color: white;
            padding: 20px 24px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 680px;
            max-width: 90vw;
            white-space: normal;
            text-align: left;
            line-height: 1.5;
            overflow-wrap: anywhere;
            pointer-events: none;
            border: 3px solid #ff5252;
            animation: bubblePop 0.3s ease-out;
            margin-top: 10px;
        }

        [title]:hover::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border: 12px solid transparent;
            border-bottom-color: #ff6b6b;
            margin-top: -2px;
            z-index: 10000;
            pointer-events: none;
            animation: bubblePop 0.3s ease-out;
        }

        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border: 12px solid transparent;
            border-bottom-color: #ff6b6b;
            margin-top: -2px;
            z-index: 10000;
            pointer-events: none;
            animation: bubblePop 0.3s ease-out;
        }

        /* When JS tooltips are active, suppress CSS pseudo-tooltips */
        body.js-tooltips-active [data-tooltip]:hover::after,
        body.js-tooltips-active [data-tooltip]:hover::before {
            content: none !important;
            display: none !important;
        }

        /* Position tooltips to the RIGHT of labels inside input rows, so they don't cover inputs */
        .control-group .input-row label[data-tooltip]:hover::after {
            top: 0;
            left: 100%;
            transform: translateX(12px);
            margin-top: 0;
        }

        .control-group .input-row label[data-tooltip]:hover::before {
            top: 10px;
            left: calc(100% + 0px);
            transform: none;
            border: 12px solid transparent;
            border-right-color: #ff6b6b;
            border-bottom-color: transparent;
            margin-top: 0;
        }

        /* On small screens, revert to below to avoid off-screen overflow */
        @media (max-width: 768px) {
            .control-group .input-row label[data-tooltip]:hover::after {
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                margin-top: 10px;
            }
            .control-group .input-row label[data-tooltip]:hover::before {
                top: 100%;
                left: 50%;
                transform: translateX(-50%);
                border-right-color: transparent;
                border-bottom-color: #ff6b6b;
                margin-top: -2px;
            }
        }

        /* JS-driven tooltip bubble */
        .tooltip-bubble {
            position: fixed;
            z-index: 10000;
            background: #ff6b6b;
            color: #ffffff;
            padding: 20px 24px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 3px solid #ff5252;
            line-height: 1.5;
            max-width: 90vw;
            pointer-events: none;
            white-space: pre-wrap;
        }
        .tooltip-bubble.theme-accent {
            background: #f59e0b;
            border-color: #fbbf24;
            color: #1f2937;
        }

        /* Force open to the LEFT to avoid right-edge overflow */
        .control-group .input-row label.tooltip-left[data-tooltip]:hover::after {
            top: 0;
            left: auto;
            right: 100%;
            transform: translateX(-12px);
            margin-top: 0;
        }
        .control-group .input-row label.tooltip-left[data-tooltip]:hover::before {
            top: 10px;
            left: auto;
            right: calc(100% + 0px);
            transform: none;
            border: 12px solid transparent;
            border-left-color: #ff6b6b;
            border-bottom-color: transparent;
            margin-top: 0;
        }

        @keyframes bubblePop {
            0% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: translateX(-50%) scale(1.1);
            }
            100% {
                transform: translateX(-50%) scale(1);
                opacity: 1;
            }
        }

        .btn {
            background: #f8f9fa;
            color: #495057;
            border: 2px solid #dee2e6;
            padding: 8px 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            width: 100%;
            height: 36px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            background: #ffffff;
            border-color: #ced4da;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .btn:active {
            background: #f8f9fa;
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }


        .temperature-bar {
            background: linear-gradient(to right, #1e40af 0%, #60a5fa 25%, #ffffff 50%, #f87171 75%, #dc2626 100%);
            height: 40px;
            position: relative;
            margin: 5px 0 20px 0;
            overflow: visible;
            border: 1px solid #ccc;
        }

        .temp-marker {
            position: absolute;
            top: -8px;
            transform: translateX(-50%);
        }

        .marker-line {
            width: 2px;
            height: 48px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .heating-design .marker-line,
        .cooling-design .marker-line {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .marker-line .temp-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            z-index: 20;
            text-align: center;
            line-height: 1;
            margin: 0;
            padding: 0;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        .marker-label {
            background: white;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            border: 1px solid #ccc;
        }

        .heating-design .marker-line { 
            background: #60a5fa; 
            width: 4px;
            box-shadow: 0 0 8px rgba(96, 165, 250, 0.5);
        }
        .cooling-design .marker-line { 
            background: #dc2626; 
            width: 4px;
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.5), 0 0 16px rgba(0, 0, 0, 0.9), 0 0 24px rgba(0, 0, 0, 0.7);
            border: 2px solid #991b1b;
        }
        .average-cold .marker-line { 
            background: #1e40af; 
            width: 4px;
            box-shadow: 0 0 8px rgba(30, 64, 175, 0.6);
            border: 2px solid #1f2937;
        }
        .average-hot .marker-line { 
            background: #dc2626; 
            width: 4px;
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.6);
            border: 2px solid #1f2937;
        }

        .temp-icon {
            font-size: 1.2rem;
            margin-right: 4px;
        }

        .snowflake-icon {
            font-size: 2rem;
            color: #ffffff;
            text-shadow: 0 0 4px rgba(0, 0, 0, 0.8);
            filter: drop-shadow(0 0 2px rgba(0, 0, 0, 0.9));
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
            z-index: 20;
        }

        .triangle-marker {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #10b981;
            font-size: 20px;
            z-index: 20;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.8));
        }

        .cold-triangle {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #3b82f6;
            z-index: 20;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
        }

        .cold-triangle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 16px solid #ffffff;
        }

        .hot-triangle {
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-bottom: 20px solid #f97316;
            z-index: 20;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
        }

        .hot-triangle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: -10px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 16px solid #ffffff;
        }

        .custom-sun {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2rem;
            height: 2rem;
            background: #fbbf24;
            border-radius: 50%;
            z-index: 20;
            filter: drop-shadow(0 0 4px rgba(0,0,0,0.8));
            border: 2px solid #ffffff;
        }

        .custom-sun::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 0;
            height: 0;
            border-left: 1px solid transparent;
            border-right: 1px solid transparent;
            border-bottom: 4px solid #fbbf24;
            z-index: 21;
        }

        .custom-sun::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 0;
            height: 0;
            border-left: 1px solid transparent;
            border-right: 1px solid transparent;
            border-bottom: 4px solid #fbbf24;
            z-index: 21;
        }

        .custom-sun {
            background-image: 
                radial-gradient(circle, #ffffff 0%, #fbbf24 100%),
                conic-gradient(from 0deg, 
                    transparent 0deg, #fbbf24 15deg, transparent 30deg,
                    #fbbf24 45deg, transparent 60deg,
                    #fbbf24 75deg, transparent 90deg,
                    #fbbf24 105deg, transparent 120deg,
                    #fbbf24 135deg, transparent 150deg,
                    #fbbf24 165deg, transparent 180deg,
                    #fbbf24 195deg, transparent 210deg,
                    #fbbf24 225deg, transparent 240deg,
                    #fbbf24 255deg, transparent 270deg,
                    #fbbf24 285deg, transparent 300deg,
                    #fbbf24 315deg, transparent 330deg,
                    #fbbf24 345deg, transparent 360deg);
        }


        .house-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
        }

        .house-symbol {
            font-size: 2.5rem;
            background: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 4px;
        }

        .temp-scale {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 0 10px;
            font-size: 0.8rem;
            color: #666;
        }

        .scale-marker {
            font-size: 0.7rem;
            color: #666;
            font-weight: bold;
            text-align: center;
        }

        .cost-comparison {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-bottom: 20px;
        }

        .cost-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .cost-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .cost-box h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .cost-amount {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0;
        }

        .emissions-amount {
            position: absolute;
            left: 12px;
            right: 12px;
            bottom: 12px;
            font-size: 0.9rem;
            color: #555;
            text-align: center;
            margin: 0;
        }

        .emissions-coal {
            margin-top: 6px;
            display: flex;
            gap: 2px;
            flex-wrap: nowrap;
            align-items: center;
            min-height: 12px;
            justify-content: center;
        }
        .coal-lump {
            width: 8px;
            height: 10px;
            background: #1f2937;
            border-radius: 2px;
            box-shadow: inset 0 0 2px rgba(255,255,255,0.08), 0 1px 1px rgba(0,0,0,0.3);
        }
        .coal-lump.empty { background: #e5e7eb; box-shadow: inset 0 0 1px rgba(0,0,0,0.08); }

        /* Emissions bar area beneath boxes */
        .emissions-bars { display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
        .emissions-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .emission-bar { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .emissions-row { display: flex; gap: 2px; justify-content: center; }
        /* Center the Annual summary vertically within the bar */
        .annual-summary {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        /* Nudge hybrid block in Home Energy Needs to vertical-center with others */
        .annual-hybrid { position: relative; top: -6px; }

        .heat-pump-box {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        }

        .furnace-box {
            background: linear-gradient(135deg, #ffe8e8 0%, #fff0f0 100%);
        }

        .hybrid-box {
            background: linear-gradient(135deg, #fff8e8 0%, #fffaf0 100%);
        }

        .cost-box.lowest {
            position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3), 0 0 40px rgba(255, 215, 0, 0.15);
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .cost-box.lowest::before {
            content: 'LOWEST RUN COST';
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #ffd700;
            color: #2c3e50;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            border: 2px solid #ffed4e;
        }

        .cost-comparison h3 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            position: relative;
        }

        .sun-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjI1IiBmaWxsPSIjRkZEMDAwIi8+CjxwYXRoIGQ9Ik01MCAxMFYxNUw1MCAxMFoiIGZpbGw9IiNGRkQwMDAiLz4KPHBhdGggZD0iTTkwIDUwSDg1TDUwIDUwSDkwWiIgZmlsbD0iI0ZGRDAwMCIvPgo8cGF0aCBkPSJNNTAgOTBWOThMNTAgOTBaIiBmaWxsPSIjRkZEMDAwIi8+CjxwYXRoIGQ9Ik0xMCA1MEgxNUw1MCA1MEgxMFoiIGZpbGw9IiNGRkQwMDAiLz4KPHBhdGggZD0iTTc3LjA3IDEwTDIyLjkzIDEwTDc3LjA3IDEwWiIgZmlsbD0iI0ZGRDAwMCIvPgo8cGF0aCBkPSJNODkuMDcgMjIuOTNMNzcuMDcgMzQuOTNMODkuMDcgMjIuOTNaIiBmaWxsPSIjRkZEMDAwIi8+CjxwYXRoIGQ9Ik03Ny4wNyA5MEwyMi45MyA5MEw3Ny4wNyA5MFoiIGZpbGw9IiNGRkQwMDAiLz4KPHBhdGggZD0iTTIyLjkzIDc3LjA3TDEwLjA3IDg5LjA3TDIyLjkzIDc3LjA3WiIgZmlsbD0iI0ZGRDAwMCIvPgo8cGF0aCBkPSJNMjIuOTMgMjIuOTNMMTAuMDcgMTAuOTNMMjIuOTMgMjIuOTNaIiBmaWxsPSIjRkZEMDAwMCIvPgo8cGF0aCBkPSJNODkuMDcgNzcuMDdMNzcuMDcgNjUuMDdMODkuMDcgNzcuMDdaIiBmaWxsPSIjRkZEMDAwMCIvPgo8cGF0aCBkPSJNNTAgMTBWNThMNTAgMTBaIiBmaWxsPSIjRkZEMDAwIi8+CjxwYXRoIGQ9Ik01MCA0MlY5OEw1MCA0MloiIGZpbGw9IiNGRkQwMDAiLz4KPHBhdGggZD0iTTEwIDUwSDY2TDUwIDUwSDEwWiIgZmlsbD0iI0ZGRDAwMCIvPgo8cGF0aCBkPSJNNTAgNTBINjZMNTAgNTBIMTAwWiIgZmlsbD0iI0ZGRDAwMCIvPgo8L3N2Zz4K');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
        }

        .sun-icon-new {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 19px;
            height: 19px;
            background: radial-gradient(circle, #ffd700 35%, #ffed4e 100%);
            border-radius: 50%;
            box-shadow: 0 1px 4px rgba(255, 215, 0, 0.4);
            z-index: 10;
            line-height: 1;
        }

        .sun-icon-new::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 27px;
            height: 27px;
            background: conic-gradient(from 0deg, 
                transparent 0deg, #ffd700 10deg, transparent 20deg,
                transparent 22.5deg, #ffd700 32.5deg, transparent 42.5deg,
                transparent 45deg, #ffd700 55deg, transparent 65deg,
                transparent 67.5deg, #ffd700 77.5deg, transparent 87.5deg,
                transparent 90deg, #ffd700 100deg, transparent 110deg,
                transparent 112.5deg, #ffd700 122.5deg, transparent 132.5deg,
                transparent 135deg, #ffd700 145deg, transparent 155deg,
                transparent 157.5deg, #ffd700 167.5deg, transparent 177.5deg,
                transparent 180deg, #ffd700 190deg, transparent 200deg,
                transparent 202.5deg, #ffd700 212.5deg, transparent 222.5deg,
                transparent 225deg, #ffd700 235deg, transparent 245deg,
                transparent 247.5deg, #ffd700 257.5deg, transparent 267.5deg,
                transparent 270deg, #ffd700 280deg, transparent 290deg,
                transparent 292.5deg, #ffd700 302.5deg, transparent 312.5deg,
                transparent 315deg, #ffd700 325deg, transparent 335deg,
                transparent 337.5deg, #ffd700 347.5deg, transparent 357.5deg);
            border-radius: 50%;
            z-index: -1;
        }

        .hybrid-split {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #dee2e6;
        }

        .hybrid-split h4 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }


        .winner-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1f2937;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .vertical-chart {
            margin-top: 20px;
            display: flex;
            align-items: end;
            gap: 20px;
            height: 300px;
        }

        .chart-bars {
            display: flex;
            align-items: end;
            gap: 20px;
            flex: 1;
        }

        .bar-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            height: 100%;
            position: relative;
        }

        .bar-fill {
            width: 100%;
            transition: height 0.8s ease;
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 8px;
            min-height: 30px;
            height: 30px;
            border: 1px solid #ccc;
        }

        .bar-fill.heat-pump {
            background: #28a745;
        }

        .bar-fill.furnace {
            background: #dc3545;
        }

        .bar-fill.hybrid {
            background: #ffc107;
        }

        .bar-label {
            margin-top: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            text-align: center;
        }

        .bar-amount {
            position: absolute;
            top: -25px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            background: white;
            padding: 2px 6px;
            border: 1px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chart-scale {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            margin-left: 16px;
        }

        .scale-line {
            font-size: 0.8rem;
            font-weight: bold;
            color: #666;
            text-align: right;
            padding-right: 8px;
        }

        .winner-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #28a745;
            color: white;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border: 1px solid #f5c6cb;
            margin: 12px 0;
            font-size: 0.9rem;
        }

        .attribution {
            background: #f8f9fa;
            color: #666;
            padding: 12px 20px;
            text-align: center;
            font-size: 0.8rem;
            border-top: 1px solid #dee2e6;
        }

        .attribution a {
            color: #007bff;
            text-decoration: none;
        }

        .attribution a:hover {
            text-decoration: underline;
        }

        .technical-section {
            margin-top: 20px;
            border-top: 2px solid #dee2e6;
            padding-top: 20px;
        }

        .tech-toggle {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
            padding: 8px 16px;
            font-size: 0.9rem;
            font-weight: normal;
            cursor: pointer;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .tech-toggle:hover {
            background: #e9ecef;
            color: #333;
        }

        .technical-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 20px;
            margin-top: 10px;
        }

        .technical-info h4 {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .tech-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tech-group h5 {
            font-size: 1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
        }

        .tech-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 4px 0;
        }

        .tech-label {
            font-weight: bold;
            color: #666;
        }

        .tech-value {
            color: #333;
            font-family: monospace;
        }

        .system-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .system-detail {
            background: white;
            border: 1px solid #dee2e6;
            padding: 15px;
        }

        .system-detail h6 {
            font-size: 0.9rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
            background: #e9ecef;
            padding: 5px;
            margin: -15px -15px 10px -15px;
        }

        .usage-bar-container {
            margin-top: 15px;
        }

        .usage-bar {
            display: flex;
            height: 40px;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .usage-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
            transition: width 0.8s ease;
            position: relative;
        }

        .heat-pump-segment {
            background: #28a745;
        }

        .furnace-segment {
            background: #dc3545;
        }

        .usage-label {
            margin-right: 8px;
        }

        .usage-percentage {
            font-size: 0.8rem;
            background: rgba(0,0,0,0.2);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .usage-explanation {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }

        /* Mini charts in Technical Details */
        .mini-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
        }
        @media (max-width: 1200px) { .mini-charts { grid-template-columns: 1fr; } }
        .mini-chart {
            border: 1px solid #dee2e6;
            background: #fafafa;
            padding: 10px;
        }
        .mini-chart h6 { margin: 0 0 8px 0; font-size: 0.95rem; color: #333; }
        .mini-chart-body { display: flex; gap: 24px; align-items: flex-end; height: 200px; justify-content: space-around; }
        .mini-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
        .mini-bars { display: flex; gap: 6px; align-items: flex-end; height: 160px; }
        .mini-bar { width: 12px; position: relative; border-radius: 2px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        /* Match main box themes */
        /* Bright palette (Run Cost Totals) */
        .mini-bar.color-heatpump { background: #28a745; }
        .mini-bar.color-furnace { background: #dc3545; }
        .mini-bar.color-hybrid { background: #ffc107; }
        /* Darker palette for CO2 chart only */
        #co2Chart .mini-bar.color-heatpump { background: #166534; }
        #co2Chart .mini-bar.color-furnace { background: #7f1d1d; }
        #co2Chart .mini-bar.color-hybrid { background: #b45309; }
        .mini-bar::after { content: attr(data-value); position: absolute; top: -18px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: #333; }
        .mini-label { text-align: center; font-size: 0.8rem; margin-top: 0; color: #555; }

        @media (max-width: 1200px) {
            .tech-grid {
                grid-template-columns: 1fr;
            }
            
            .system-details {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 1200px) {
            .controls-grid {
                grid-template-columns: 1fr;
            }
            
            .detailed-cards {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 12px 16px;
            }
            
            .input-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Heat Pump - Furnace - Hybrid</h1>
            <p>Cost to Run Comparison</p>
            <div class="emissions-toggle">
                <input type="checkbox" id="includeEmissions" onchange="recalculateIfDataAvailable()">
                <label for="includeEmissions">Include emissions</label>
            </div>
        </div>

        <div class="main-content">
            <!-- Controls -->
            <div class="controls-grid">
                <!-- Location -->
                <div class="control-group" style="padding: 15px; height: 175px;">
                    <h3>Location</h3>
                    <div class="input-row">
                        <div class="input-field">
                            <input type="text" id="zipCode" placeholder="Zip Code" maxlength="5">
                        </div>
                        <div class="input-field">
                            <button class="btn" id="lookupBtn" onclick="lookupClimateData()">Lookup</button>
                        </div>
                    </div>
                    <div id="locationInfo" class="location-info" style="display: none;">
                        <div id="locationName" class="location-name"></div>
                        <div id="dataSource" class="data-source"></div>
                    </div>
                </div>

                <!-- Energy Costs -->
                <div class="control-group" style="padding: 15px; height: 175px;">
                    <div style="margin-bottom: 15px;">
                        <label for="electricityRate" class="tooltip-below" data-tooltip="Use your 'blended rate' (total bill ÷ total kWh) - includes all fees. Check for time-of-use rates. Rates vary greatly by region and provider. National average: $.12-.15/kWh energy cost." style="display: block; font-size: 0.9rem; font-weight: bold; color: #333; margin-bottom: 5px; position: relative;">
                            Electricity Rate ($/kWh)
                            <span class="info-dot">i</span>
                        </label>
                        <input type="number" id="electricityRate" value="0.18" step="0.01" min="0" style="width: 120px; padding: 8px 12px; border: 1px solid #ccc; font-size: 0.9rem;">
                    </div>
                    <div>
                        <label for="gasRate" class="tooltip-below" data-tooltip="Use 'total delivered rate' per therm - includes all fees. Rates vary significantly by season. National average: $1.64/therm delivered." style="display: block; font-size: 0.9rem; font-weight: bold; color: #333; margin-bottom: 5px; position: relative;">
                            Natural Gas Rate ($/therm)
                            <span class="info-dot">i</span>
                        </label>
                        <input type="number" id="gasRate" value="1.64" step="0.01" min="0" style="width: 120px; padding: 8px 12px; border: 1px solid #ccc; font-size: 0.9rem;">
                    </div>
                </div>

                <!-- Equipment Performance -->
                <div class="control-group" style="padding: 15px; height: 175px;">
                    <div class="input-row">
                        <div class="input-field">
                            <label for="heatPumpCOP" data-tooltip="A heat pump's &quot;Coefficient of Performance&quot; describes how much heat it can deliver for each unit of energy it uses. A C.O.P. of 3 is the equivalent of 300% efficient! A heat pump with a C.O.P. of 3 uses one-third the electricity of resistance heat for the same amount of heating.\n\nHeat pumps differ greatly in their performance based on their rated capacity, matched equipment in the rest of the system, the quality of installation, and operating conditions. Current high performance heat pumps have C.O.P.'s of 3 to 4." style="position: relative;">
                                Heat Pump <span class="info-dot">i</span><br>Performance
                            </label>
                            <input type="number" id="heatPumpCOP" value="3.5" step="0.1" min="1" max="5">
                        </div>
                        <div class="input-field">
                            <label for="furnaceEfficiency" data-tooltip="Annual Fuel Utilization Efficiency - percentage of fuel converted to heat. Higher is better." style="position: relative;">
                                Furnace <span class="info-dot">i</span><br>Efficiency (%)
                            </label>
                            <input type="number" id="furnaceEfficiency" value="95" step="1" min="70" max="100">
                        </div>
                    </div>
                    <div class="input-row" style="margin-top: 15px;">
                        <div class="input-field">
                            <label for="crossoverTemp" data-tooltip="Temperature below which hybrid system switches from heat pump to furnace for better efficiency" style="position: relative;">
                                Hybrid Crossover Temperature (°F)
                                <span class="info-dot">i</span>
                            </label>
                            <input type="number" id="crossoverTemp" value="35" step="1" min="20" max="50">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heating Load Input -->
            <div class="control-group" style="padding: 10px; height: 60px; grid-column: 1 / -1; width: 100%; display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="heatingLoadInput" data-tooltip="Enter your home's heat loss in BTU per hour. This is the amount of heat your equipment needs to provide every hour on the coldest day(s) of the year to keep your house at a comfortable temperature. This number is typically calculated by an HVAC professional using a thermal model of your home called a 'Manual J Load Calculation'." style="font-size: 0.9rem; font-weight: bold; color: #333; position: relative; white-space: nowrap;">
                        Home Energy Needs (BTU per Hour)
                        <span style="position: absolute; top: -5px; right: -20px; width: 14px; height: 14px; background: #6c757d; color: #ffffff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">i</span>
                    </label>
                    <input type="text" id="heatingLoadInput" placeholder="50,000" value="50000" style="width: 120px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem; text-align: center;" oninput="formatHeatingInput(this); updateHeatingLoad();">
                </div>
                <div class="annual-summary" style="font-size: 0.9rem;">
                    <div style="font-weight: bold; color: #333; margin-bottom: 5px;">Annual:</div>
                    <div style="display: flex; gap: 25px; font-size: 0.8rem;">
                        <div style="text-align: center;">
                            <div style="color: #dc3545; font-weight: bold;" id="annualGasHeat">0 therms</div>
                            <div style="color: #666; font-size: 0.7rem;">Gas Furnace</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="color: #007bff; font-weight: bold;" id="annualHeatPump">0 kWh</div>
                            <div style="color: #666; font-size: 0.7rem;">Heat Pump</div>
                        </div>
                        <div style="text-align: center;" class="annual-hybrid">
                            <div style="color: #28a745; font-weight: bold;" id="annualHybridGas">0 therms</div>
                            <div style="color: #ffc107; font-weight: bold;" id="annualHybridElec">0 kWh</div>
                            <div style="color: #666; font-size: 0.7rem;">Hybrid</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temperature Bar -->
            <div id="temperatureBar">
                <div class="temp-scale">
                    <div class="scale-marker">-20°F</div>
                    <div class="scale-marker">0°F</div>
                    <div class="scale-marker">20°F</div>
                    <div class="scale-marker">40°F</div>
                    <div class="scale-marker">60°F</div>
                    <div class="scale-marker">80°F</div>
                    <div class="scale-marker">100°F</div>
                    <div class="scale-marker">120°F</div>
                </div>
                <div class="temperature-bar">
                    <div class="temp-marker heating-design" id="heatingMarker">
                        <div class="marker-line">
                            <div class="snowflake-icon">❄</div>
                        </div>
                        <div class="marker-label">
                            99% Cold<br><span id="heatingDesign">--</span>°F
                        </div>
                    </div>
                    <div class="temp-marker cooling-design" id="coolingMarker">
                        <div class="marker-line">
                            <div class="sun-icon-new"></div>
                        </div>
                        <div class="marker-label">
                            1% Heat<br><span id="coolingDesign">--</span>°F
                        </div>
                    </div>
                    <div class="temp-marker average-cold" id="avgColdMarker">
                        <div class="marker-line">
                            <div class="cold-triangle"></div>
                        </div>
                    </div>
                    <div class="house-icon" id="houseIcon">
                        <div class="house-symbol">🏠</div>
                    </div>
                    <div class="temp-marker average-hot" id="avgHotMarker">
                        <div class="marker-line">
                            <div class="hot-triangle"></div>
                        </div>
                    </div>
                </div>
                <!-- Average temp labels below the bar -->
                <div style="position: relative; height: 60px; margin-top: 10px;">
                    <div class="marker-label" style="position: absolute; text-align: center; transform: translateX(-50%);">Avg Cold<br><span id="avgCold">--</span>°F</div>
                    <div class="marker-label" style="position: absolute; text-align: center; transform: translateX(-50%);">Avg Hot<br><span id="avgHot">--</span>°F</div>
                </div>
            </div>

            <!-- Loading -->
            <div id="loadingSection" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Calculating costs...</p>
            </div>

            <!-- Error -->
            <div id="errorSection" class="error" style="display: none;"></div>

            <!-- Cost Comparison -->
            <div id="resultsSection" class="cost-comparison">
                <div class="cost-grid">
                    <div class="cost-box heat-pump-box" id="heatPumpBox">
                        <h3>Heat Pump</h3>
                        <div class="cost-amount" id="heatPumpTotal">$0</div>
                        <div class="emissions-amount" id="hpEmissions" style="display:none"></div>
                    </div>
                    <div class="cost-box furnace-box" id="furnaceBox">
                        <h3>Furnace</h3>
                        <div class="cost-amount" id="furnaceTotal">$0</div>
                        <div class="emissions-amount" id="furnaceEmissions" style="display:none"></div>
                    </div>
                    <div class="cost-box hybrid-box" id="hybridBox">
                        <h3>Hybrid</h3>
                        <div class="cost-amount" id="hybridTotal">$0</div>
                        <div class="emissions-amount" id="hybridEmissions" style="display:none"></div>
                    </div>
                </div>

                <div class="emissions-bars" id="emissionsBars">
                    <div class="emissions-grid">
                        <div class="emission-bar">
                            <div class="emissions-row" id="hpCoalRow1"></div>
                            <div class="emissions-row" id="hpCoalRow2"></div>
                        </div>
                        <div class="emission-bar">
                            <div class="emissions-row" id="furnaceCoalRow1"></div>
                            <div class="emissions-row" id="furnaceCoalRow2"></div>
                        </div>
                        <div class="emission-bar">
                            <div class="emissions-row" id="hybridCoalRow1"></div>
                            <div class="emissions-row" id="hybridCoalRow2"></div>
                        </div>
                    </div>
                </div>

                <!-- Hybrid System Split -->
                <div class="hybrid-split" id="hybridSplit" style="display: none;">
                    <h4>Hybrid System Heating Split</h4>
                    <div class="usage-bar-container">
                        <div class="usage-bar">
                            <div class="usage-segment heat-pump-segment" id="heatPumpSegment" style="width: 0%">
                                <span class="usage-label">Heat Pump</span>
                                <span class="usage-percentage" id="heatPumpPercentage">0%</span>
                            </div>
                            <div class="usage-segment furnace-segment" id="furnaceSegment" style="width: 0%">
                                <span class="usage-label">Furnace</span>
                                <span class="usage-percentage" id="furnacePercentage">0%</span>
                            </div>
                        </div>
                        <div class="usage-explanation">
                            <p id="usageExplanation">Enter a zip code to see how the hybrid system splits heating between heat pump and furnace.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Technical Information -->
            <div class="technical-section">
                <button class="tech-toggle" onclick="toggleTechnicalInfo()">
                    <span id="techToggleText">Show Technical Details</span>
                    <span id="techToggleIcon">▼</span>
                </button>
                <div id="technicalInfo" class="technical-info" style="display: none;">
                    <h4>Calculation Assumptions & Details</h4>
                    
                    <div class="tech-grid">
                        <div class="tech-group">
                            <h5>House Specifications</h5>
                            <div class="tech-item">
                                <span class="tech-label">House Size:</span>
                                <span class="tech-value" id="houseSize">2,000 sq ft</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Heating Load Factor:</span>
                                <span class="tech-value" id="heatingLoadFactor">1.2 BTU/sq ft/HDD</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Cooling Load Factor:</span>
                                <span class="tech-value" id="coolingLoadFactor">1.0 BTU/sq ft/CDD</span>
                            </div>
                        </div>

                        <div class="tech-group">
                            <h5>Climate Data</h5>
                            <div class="tech-item">
                                <span class="tech-label">Heating Degree Days:</span>
                                <span class="tech-value" id="hddValue">--</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Cooling Degree Days:</span>
                                <span class="tech-value" id="cddValue">--</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">99% Heating Design:</span>
                                <span class="tech-value" id="heatingDesignValue">--°F</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">1% Cooling Design:</span>
                                <span class="tech-value" id="coolingDesignValue">--°F</span>
                            </div>
                        </div>

                        <div class="tech-group">
                            <h5>Energy Calculations</h5>
                            <div class="tech-item">
                                <span class="tech-label">Total Heating BTU:</span>
                                <span class="tech-value" id="totalHeatingBTU">--</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Total Cooling BTU:</span>
                                <span class="tech-value" id="totalCoolingBTU">--</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Electricity Rate:</span>
                                <span class="tech-value" id="electricityRateValue">$0.12/kWh</span>
                            </div>
                            <div class="tech-item">
                                <span class="tech-label">Natural Gas Rate:</span>
                                <span class="tech-value" id="gasRateValue">$1.20/therm</span>
                            </div>
                        </div>
                    </div>

                    <div class="tech-group">
                        <h5>System Performance Details</h5>
                        <div class="system-details">
                            <div class="system-detail">
                                <h6>Heat Pump System</h6>
                                <div class="tech-item">
                                    <span class="tech-label">COP (Heating):</span>
                                    <span class="tech-value" id="heatPumpCOPValue">3.5</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">SEER (Cooling):</span>
                                    <span class="tech-value">18</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Heating Efficiency:</span>
                                    <span class="tech-value" id="heatPumpHeatingEff">--</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Cooling Efficiency:</span>
                                    <span class="tech-value" id="heatPumpCoolingEff">--</span>
                                </div>
                            </div>

                            <div class="system-detail">
                                <h6>Furnace System</h6>
                                <div class="tech-item">
                                    <span class="tech-label">AFUE (Heating):</span>
                                    <span class="tech-value" id="furnaceAFUEValue">95%</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">SEER (Cooling):</span>
                                    <span class="tech-value">16</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Heating Efficiency:</span>
                                    <span class="tech-value" id="furnaceHeatingEff">--</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Cooling Efficiency:</span>
                                    <span class="tech-value" id="furnaceCoolingEff">--</span>
                                </div>
                            </div>

                            <div class="system-detail">
                                <h6>Hybrid System</h6>
                                <div class="tech-item">
                                    <span class="tech-label">Crossover Temperature:</span>
                                    <span class="tech-value" id="crossoverTempValue">--°F</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Heat Pump Usage:</span>
                                    <span class="tech-value" id="hybridHeatPumpUsage">--</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Furnace Usage:</span>
                                    <span class="tech-value" id="hybridFurnaceUsage">--</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Heating Efficiency:</span>
                                    <span class="tech-value" id="hybridHeatingEff">--</span>
                                </div>
                                <div class="tech-item">
                                    <span class="tech-label">Cooling Efficiency:</span>
                                    <span class="tech-value" id="hybridCoolingEff">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="attribution">
            <p>
                Climate Data: <a href="https://www.ncei.noaa.gov/" target="_blank">NOAA</a> | 
                Location: <a href="https://zippopotam.us/" target="_blank">Zippopotam</a> | 
                Methodology: <a href="https://www.ashrae.org/" target="_blank">ASHRAE</a>
            </p>
        </div>
    </div>

    <!-- Load authoritative county-level ASHRAE dataset -->
    <script src="ashrae_county_data.js"></script>
    <!-- Legacy city/zip dataset (not used for calculations anymore) -->
    <script src="resnet_ashrae_data.js"></script>
    
    <script>
        // Global variables
        let climateData = null;
        let maxCost = 0;
        let houseLoads = { heating: 0, cooling: 0 };

        // County-level ASHRAE design temperatures (authoritative)
        // Loaded from ashrae_county_data.js; supports datasets keyed by FIPS or any key with a 'fips' field
        const rawCountyDataset = (typeof ASHRAE_COUNTY_DATA !== 'undefined') ? ASHRAE_COUNTY_DATA : {};
        const countyAshraeData = buildCountyFipsIndex(rawCountyDataset);
        console.log('County ASHRAE data loaded:', Object.keys(countyAshraeData).length, 'counties');

        function buildCountyFipsIndex(dataset) {
            try {
                const index = {};
                const entries = Object.entries(dataset || {});
                for (const [key, value] of entries) {
                    if (!value || typeof value !== 'object') continue;
                    const fipsRaw = value.fips || value.FIPS || value.countyFIPS || value.county_fips || key;
                    const fips = (fipsRaw != null) ? String(fipsRaw).padStart(5, '0') : null;
                    if (fips) index[fips] = value;
                }
                // If we failed to derive any FIPS keys, return original (assumes already keyed by FIPS)
                return Object.keys(index).length ? index : (dataset || {});
            } catch (e) {
                console.warn('Failed to build county FIPS index:', e);
                return dataset || {};
            }
        }

        async function tryLoadExternalCountyJson() {
            // Optional: load a large county dataset without changing code
            const url = 'ashrae_county_data.json';
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return; // JSON file not present
                const json = await res.json();
                const idx = buildCountyFipsIndex(json);
                let merged = 0;
                for (const [k, v] of Object.entries(idx)) {
                    if (!countyAshraeData[k]) {
                        countyAshraeData[k] = v; // mutate const object (allowed)
                        merged++;
                    }
                }
                if (merged > 0) {
                    console.log(`Merged ${merged} counties from ashrae_county_data.json`);
                }
            } catch (e) {
                console.warn('External county JSON load skipped:', e);
            }
        }

        async function tryLoadExternalCountyCsv() {
            // Optional: CSV fallback (requires a FIPS column)
            const url = 'ashrae_county_data.csv';
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return; // CSV file not present
                const text = await res.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
                if (lines.length < 2) return;
                const header = lines[0].split(',').map(h => h.trim().toLowerCase());
                const idx = (name) => header.indexOf(name);
                const fipsIdx = [idx('fips'), idx('county_fips')].find(i => i >= 0);
                if (fipsIdx == null || fipsIdx < 0) {
                    console.warn('CSV missing FIPS column; skipping import');
                    return;
                }
                const nameIdx = [idx('name'), idx('county'), idx('county_name')].find(i => i >= 0);
                const stateIdx = [idx('state'), idx('state_abbr'), idx('state_code')].find(i => i >= 0);
                const heatingIdx = [idx('heating'), idx('heating_99'), idx('heatingdesign'), idx('heating_design')].find(i => i >= 0);
                const coolingIdx = [idx('cooling'), idx('cooling_01'), idx('coolingdesign'), idx('cooling_design')].find(i => i >= 0);
                const hddIdx = [idx('hdd'), idx('hdd65'), idx('heating_degree_days')].find(i => i >= 0);
                const cddIdx = [idx('cdd'), idx('cdd65'), idx('cooling_degree_days')].find(i => i >= 0);
                let merged = 0;
                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length <= fipsIdx) continue;
                    const fips = String(cols[fipsIdx]).trim().padStart(5, '0');
                    if (!fips || countyAshraeData[fips]) continue;
                    const getNum = (v) => {
                        const n = Number(String(v).trim());
                        return Number.isFinite(n) ? n : undefined;
                    };
                    const entry = {
                        name: nameIdx != null && nameIdx >= 0 ? String(cols[nameIdx]).trim() : undefined,
                        state: stateIdx != null && stateIdx >= 0 ? String(cols[stateIdx]).trim().toUpperCase() : undefined,
                        fips: fips,
                        heating: heatingIdx != null && heatingIdx >= 0 ? getNum(cols[heatingIdx]) : undefined,
                        cooling: coolingIdx != null && coolingIdx >= 0 ? getNum(cols[coolingIdx]) : undefined,
                        hdd: hddIdx != null && hddIdx >= 0 ? getNum(cols[hddIdx]) : undefined,
                        cdd: cddIdx != null && cddIdx >= 0 ? getNum(cols[cddIdx]) : undefined,
                        source: 'External CSV import'
                    };
                    countyAshraeData[fips] = entry;
                    merged++;
                }
                if (merged > 0) console.log(`Merged ${merged} counties from ashrae_county_data.csv`);
            } catch (e) {
                console.warn('External county CSV load skipped:', e);
            }
        }

        // Simple Heating Load Input
        function updateHeatingLoad() {
            // Get the numeric value from the formatted input
            const heatingLoadInput = parseFloat(document.getElementById('heatingLoadInput').value.replace(/[^\d]/g, '')) || 0;
            
            // Estimate cooling load as 80% of heating load (typical ratio)
            const coolingLoad = Math.round(heatingLoadInput * 0.8);
            
            houseLoads = {
                heating: heatingLoadInput,
                cooling: coolingLoad
            };
            
            // Calculate annual energy needs for heating systems
            updateAnnualHeatingDisplay(heatingLoadInput);
            
            console.log('Heating load set to:', heatingLoadInput, 'BTU/hr');
        }

        function updateAnnualHeatingDisplay(heatingLoad) {
            if (!climateData) return;
            
            const hdd = climateData.hdd || 0;
            const heatingDesign = climateData.heating;
            const indoorTemp = 65;
            const heatingDesignDiff = indoorTemp - heatingDesign;
            if (heatingDesignDiff <= 0) return;
            
            // Use same degree-day method as cost path
            const heatLossRate = heatingLoad / heatingDesignDiff; // BTU/hr/°F
            const annualHeatingLoadBTU = heatLossRate * hdd * 24; // BTU/year
            
            // Inputs
            const afue = (parseFloat(document.getElementById('furnaceEfficiency').value) || 95) / 100;
            const cop = parseFloat(document.getElementById('heatPumpCOP').value) || 3.5;
            const crossoverTemp = parseFloat(document.getElementById('crossoverTemp').value) || 35;
            const hpShare = calculateHeatPumpEfficiency(heatingDesign, crossoverTemp);
            
            // Gas furnace therms at meter
            const gasTherms = annualHeatingLoadBTU / (100000 * afue);
            
            // Heat pump kWh
            const hpKWh = annualHeatingLoadBTU / (cop * 3412);
            
            // Hybrid split
            const hybridGasTherms = (annualHeatingLoadBTU * (1 - hpShare)) / (100000 * afue);
            const hybridElecKWh = (annualHeatingLoadBTU * hpShare) / (cop * 3412);
            
            // Update UI
            document.getElementById('annualGasHeat').textContent = formatNumberWithCommas(Math.round(gasTherms)) + ' therms';
            document.getElementById('annualHeatPump').textContent = formatNumberWithCommas(Math.round(hpKWh)) + ' kWh';
            document.getElementById('annualHybridGas').textContent = formatNumberWithCommas(Math.round(hybridGasTherms)) + ' therms';
            document.getElementById('annualHybridElec').textContent = formatNumberWithCommas(Math.round(hybridElecKWh)) + ' kWh';
        }

        // Format number with commas
        function formatNumberWithCommas(num) {
            if (isNaN(num) || num === null || num === undefined) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        // Format heating input with commas as user types
        function formatHeatingInput(input) {
            // Remove all non-numeric characters
            let value = input.value.replace(/[^\d]/g, '');
            
            // Add commas for thousands
            if (value.length > 0) {
                value = parseInt(value).toLocaleString();
            }
            
            // Update the input value
            input.value = value;
            
            // Trigger the update function
            updateHeatingLoad();
        }

        // Add event listener for heating load input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('heatingLoadInput').addEventListener('input', updateHeatingLoad);
            // Initialize heating load with default value
            updateHeatingLoad();
        });

        // Regional estimates removed to enforce ASHRAE-only mandate

        async function lookupClimateData() {
            const zipCode = document.getElementById('zipCode').value.trim();
            
            if (!zipCode || zipCode.length !== 5) {
                showError('Please enter a valid 5-digit zip code');
                return;
            }

            showLoading();
            hideError();
            hideResults();

            try {
                // Get location data from zip code
                let locationData;
                try {
                    console.log('Calling getLocationFromZip for:', zipCode);
                    locationData = await getLocationFromZip(zipCode);
                    console.log('Location data received:', locationData);
                } catch (error) {
                    console.error('Zip code lookup failed:', error);
                    throw new Error('Zip lookup failed');
                }
                
                // Opportunistically load a full dataset if present
                await tryLoadExternalCountyJson();
                await tryLoadExternalCountyCsv();

                // Get county FIPS from FCC API using lat/lon
                const fipsInfo = await getCountyFIPS(locationData.latitude, locationData.longitude);
                if (!fipsInfo || !fipsInfo.countyFIPS) {
                    throw new Error('Unable to resolve county FIPS');
                }
                console.log('Resolved county FIPS:', fipsInfo);

                // Lookup county in authoritative ASHRAE county dataset
                const countyEntry = countyAshraeData[fipsInfo.countyFIPS] || await tryMergeNceiHddCdd(fipsInfo.countyFIPS);
                if (!countyEntry) {
                    console.error('No county ASHRAE data found for FIPS:', fipsInfo.countyFIPS, fipsInfo);
                    reportMissingCounty(fipsInfo);
                    throw new Error(`County not loaded yet: ${fipsInfo.countyName} (${fipsInfo.countyFIPS}) ${fipsInfo.stateAbbr}`);
                }

                // Normalize expected fields
                const normalized = normalizeCountyEntry(countyEntry, fipsInfo);
                if (!Number.isFinite(normalized.heating) || !Number.isFinite(normalized.hdd)) {
                    console.error('County entry missing required heating/HDD fields after normalization:', countyEntry);
                    throw new Error('Incomplete ASHRAE county data (heating/HDD required)');
                }
                climateData = normalized;

                displayClimateData();
                calculateHVACCosts();

            } catch (error) {
                console.error('Error fetching climate data:', error);
                const msg = (error && error.message && error.message.startsWith('County not loaded yet'))
                  ? `${error.message}. Please populate this county in ashrae_county_data.js.`
                  : 'No valid county-level ASHRAE data available for this ZIP.';
                showError(msg);
            } finally {
                hideLoading();
            }
        }

        async function tryMergeNceiHddCdd(fips) {
            try {
                const url = 'ashrae_county_hdd_cdd.json';
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return null;
                const ncei = await res.json();
                const entry = ncei[fips];
                if (!entry) return null;
                // Merge HDD/CDD into existing county entry if present
                if (countyAshraeData[fips]) {
                    countyAshraeData[fips].hdd = entry.hdd;
                    countyAshraeData[fips].cdd = entry.cdd;
                    countyAshraeData[fips].source = (countyAshraeData[fips].source || '') + ' + ' + entry.source;
                    return countyAshraeData[fips];
                }
                return entry;
            } catch (e) {
                return null;
            }
        }
        function normalizeCountyEntry(entry, fipsInfo) {
            const getNum = (v) => {
                const n = Number(v);
                return Number.isFinite(n) ? n : undefined;
            };
            const heating = getNum(entry.heating) ?? getNum(entry.heating_99) ?? getNum(entry.heatingDesign) ?? getNum(entry.heating_design);
            const cooling = getNum(entry.cooling) ?? getNum(entry.cooling_01) ?? getNum(entry.coolingDesign) ?? getNum(entry.cooling_design);
            const hdd = getNum(entry.hdd) ?? getNum(entry.HDD) ?? getNum(entry.heating_degree_days) ?? getNum(entry.HDD65);
            const cdd = getNum(entry.cdd) ?? getNum(entry.CDD) ?? getNum(entry.cooling_degree_days) ?? getNum(entry.CDD65);
            const name = entry.name || `${fipsInfo.countyName}, ${fipsInfo.stateAbbr}`;
            const source = entry.source || 'Appendix A (Normative) + RESNET HDD/CDD';
            const lat = getNum(entry.lat);
            const lon = getNum(entry.lon);
            return { name, heating, cooling, hdd, cdd, source, lat, lon };
        }

        async function getLocationFromZip(zipCode) {
            try {
                console.log('Looking up zip code:', zipCode);
                const response = await fetch(`https://api.zippopotam.us/us/${zipCode}`);
                console.log('Zippopotam response status:', response.status);
                
                if (!response.ok) {
                    console.error('Zippopotam API error:', response.status, response.statusText);
                    throw new Error('Location lookup failed');
                }
                
                const data = await response.json();
                console.log('Zippopotam data:', data);
                
                if (!data.places || data.places.length === 0) {
                    throw new Error('No location data found for zip code');
                }
                
                return {
                    latitude: parseFloat(data.places[0].latitude),
                    longitude: parseFloat(data.places[0].longitude),
                    city: data.places[0]['place name'],
                    state: data.places[0]['state abbreviation']
                };
            } catch (error) {
                console.error('Zip code lookup error:', error);
                throw error;
            }
        }

        async function getCountyFIPS(lat, lon) {
            // FCC Census API - returns county FIPS and names
            const url = `https://geo.fcc.gov/api/census/area?lat=${lat}&lon=${lon}&format=json`;
            const res = await fetch(url);
            if (!res.ok) {
                console.error('FCC FIPS API error:', res.status, res.statusText);
                throw new Error('FIPS lookup failed');
            }
            const data = await res.json();
            if (!data || !data.results || data.results.length === 0) {
                throw new Error('No FIPS result for coordinates');
            }
            const county = data.results[0];
            return {
                countyFIPS: county['county_fips'] || county['FIPS'] || county['county_fips_code'] || null,
                countyName: county['county_name'] || county['name'] || 'Unknown County',
                stateAbbr: county['state_code'] || county['state_abbr'] || county['state'] || ''
            };
        }

        function reportMissingCounty(fipsInfo) {
            try {
                if (!window.MISSING_COUNTIES) window.MISSING_COUNTIES = {};
                const key = fipsInfo.countyFIPS || `${fipsInfo.countyName}-${fipsInfo.stateAbbr}`;
                window.MISSING_COUNTIES[key] = {
                    countyFIPS: fipsInfo.countyFIPS,
                    countyName: fipsInfo.countyName,
                    stateAbbr: fipsInfo.stateAbbr,
                    timestamp: new Date().toISOString()
                };
                console.log('Recorded missing county for population:', window.MISSING_COUNTIES[key]);
            } catch (e) {
                console.warn('Could not record missing county:', e);
            }
        }


        // getWeatherStationData removed to enforce ASHRAE-only mandate
        
        // getHistoricalWeatherData removed to enforce ASHRAE-only mandate
        
        function calculatePercentile(sortedArray, percentile) {
            const index = (percentile * (sortedArray.length - 1));
            const lower = Math.floor(index);
            const upper = Math.ceil(index);
            const weight = index % 1;
            
            if (upper >= sortedArray.length) return sortedArray[sortedArray.length - 1];
            return sortedArray[lower] * (1 - weight) + sortedArray[upper] * weight;
        }

        function findNearestASHRAEData(city, state, lat, lon) {
            console.log('Finding nearest ASHRAE data for:', city, state, lat, lon);
            console.log('Available ASHRAE data entries:', Object.keys(ashraeData).length);
            
            // First try exact city/state match
            for (const [zip, data] of Object.entries(ashraeData)) {
                if (data.name.includes(city) && data.name.includes(state)) {
                    console.log('Found exact match:', data);
                    return data;
                }
            }
            
            // Find the closest by distance using coordinates
            let closestData = null;
            let minDistance = Infinity;
            
            for (const [zip, data] of Object.entries(ashraeData)) {
                // Only consider entries with coordinates
                if (data.lat && data.lon) {
                    const distance = calculateDistance(lat, lon, data.lat, data.lon);
                    if (distance < minDistance) {
                        minDistance = distance;
                        closestData = data;
                    }
                }
            }
            
            console.log('Closest ASHRAE data:', closestData, 'Distance:', minDistance);
            // Integrity check: require heating, cooling, hdd, cdd to be finite numbers
            if (closestData) {
                const valid = ['heating','cooling','hdd','cdd'].every(k => Number.isFinite(closestData[k]));
                if (!valid) {
                    console.error('ASHRAE entry missing required fields:', closestData);
                    return null;
                }
            }
            return closestData;
        }

        // Minimal self-test to verify a few spot zips resolve to ASHRAE entries
        function runAshraeSelfTest() {
            const tests = ['97201','98101','10001'];
            const results = tests.map(z => ({ zip: z, ok: !!RESNET_ASHRAE_DATA[z] }));
            console.log('ASHRAE self-test:', results);
            return results;
        }
        
        // findRegionalMatch removed to enforce ASHRAE-only mandate
        
        function getGeographicRegion(lat, lon) {
            if (lat >= 45) return 'north';
            if (lat >= 35) return 'central';
            if (lat >= 25) return 'south';
            return 'tropical';
        }
        
        function getStateRegion(state) {
            const stateRegions = {
                'AK': 'north', 'WA': 'north', 'OR': 'north', 'ID': 'north', 'MT': 'north', 'ND': 'north', 'MN': 'north', 'WI': 'north', 'MI': 'north', 'ME': 'north', 'VT': 'north', 'NH': 'north',
                'CA': 'west', 'NV': 'west', 'UT': 'west', 'CO': 'west', 'WY': 'west', 'NM': 'west', 'AZ': 'west',
                'TX': 'south', 'OK': 'south', 'AR': 'south', 'LA': 'south', 'MS': 'south', 'AL': 'south', 'GA': 'south', 'FL': 'south', 'SC': 'south', 'NC': 'south', 'TN': 'south', 'KY': 'south',
                'IL': 'central', 'IN': 'central', 'OH': 'central', 'PA': 'central', 'NY': 'central', 'NJ': 'central', 'CT': 'central', 'RI': 'central', 'MA': 'central', 'VT': 'central', 'NH': 'central', 'ME': 'central',
                'IA': 'central', 'MO': 'central', 'KS': 'central', 'NE': 'central', 'SD': 'central', 'ND': 'central'
            };
            return stateRegions[state] || 'central';
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            // Haversine formula for calculating distance between two points
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // getRegionalEstimate removed to enforce ASHRAE-only mandate

        function getRegionFromZip(zipCode) {
            const firstDigit = zipCode[0];
            const firstTwoDigits = zipCode.substring(0, 2);
            
            if (firstTwoDigits === '33') return 'southflorida';
            if (firstDigit >= '0' && firstDigit <= '2') return 'northeast';
            if (firstDigit >= '3' && firstDigit <= '4') return 'south';
            if (firstDigit >= '5' && firstDigit <= '6') return 'midwest';
            if (firstDigit >= '7' && firstDigit <= '8') return 'west';
            if (firstDigit === '9') return 'northwest';
            return 'midwest';
        }

        function calculateHDD(heatingDesign) {
            const baseTemp = 65;
            const dailyHDD = Math.max(0, baseTemp - heatingDesign);
            return Math.round(dailyHDD * 365.25);
        }

        function calculateCDD(coolingDesign) {
            const baseTemp = 65;
            const dailyCDD = Math.max(0, coolingDesign - baseTemp);
            return Math.round(dailyCDD * 365.25);
        }

        function displayClimateData() {
            // Enforce integrity: heating + HDD required; cooling optional (not used)
            if (!climateData || !Number.isFinite(climateData.heating) || !Number.isFinite(climateData.hdd)) {
                console.error('Invalid ASHRAE county climate data:', climateData);
                showError('Invalid ASHRAE county data for this ZIP.');
                return;
            }
            document.getElementById('locationName').textContent = climateData.name;
            document.getElementById('dataSource').textContent = `Data source: ${climateData.source}`;
            document.getElementById('locationInfo').style.display = 'block';

            document.getElementById('heatingDesign').textContent = climateData.heating;
            // Show cooling design on chart if present (visual only; not used in pricing)
            if (document.getElementById('coolingDesign')) {
                document.getElementById('coolingDesign').textContent = Number.isFinite(climateData.cooling) ? climateData.cooling : '--';
            }

            const avgCold = Math.round((climateData.heating + 65) / 2);
            document.getElementById('avgCold').textContent = avgCold;
            if (document.getElementById('avgHot')) {
                const avgHotVal = Number.isFinite(climateData.cooling) ? Math.round((climateData.cooling + 65) / 2) : null;
                document.getElementById('avgHot').textContent = (avgHotVal != null) ? avgHotVal : '--';
            }
            
            // Update heating load when climate data is available
            updateHeatingLoad();
            
            positionTemperatureMarkers();
            document.getElementById('temperatureBar').style.display = 'block';

            // Show cooling markers/labels if cooling data present
            const hasCooling = Number.isFinite(climateData.cooling);
            const coolingMarker = document.getElementById('coolingMarker');
            if (coolingMarker) coolingMarker.style.display = hasCooling ? '' : 'none';
            const avgHotMarker = document.getElementById('avgHotMarker');
            if (avgHotMarker) avgHotMarker.style.display = hasCooling ? '' : 'none';
        }

        function positionTemperatureMarkers() {
            const minTemp = -20;
            const maxTemp = 120;
            const range = maxTemp - minTemp;
            
            const heatingPos = ((climateData.heating - minTemp) / range) * 100;
            const avgColdPos = ((Math.round((climateData.heating + 65) / 2) - minTemp) / range) * 100;
            const hasCooling = Number.isFinite(climateData.cooling);
            const coolingPos = hasCooling ? ((climateData.cooling - minTemp) / range) * 100 : null;
            const avgHotPos = hasCooling ? ((Math.round((climateData.cooling + 65) / 2) - minTemp) / range) * 100 : null;

            document.getElementById('heatingMarker').style.left = heatingPos + '%';
            document.getElementById('avgColdMarker').style.left = avgColdPos + '%';
            if (hasCooling && document.getElementById('coolingMarker')) {
                document.getElementById('coolingMarker').style.left = coolingPos + '%';
            }
            if (hasCooling && document.getElementById('avgHotMarker')) {
                document.getElementById('avgHotMarker').style.left = avgHotPos + '%';
            }

            // Position average temp labels to match their markers
            document.querySelector('#avgCold').parentElement.style.left = avgColdPos + '%';
            if (hasCooling) {
                document.querySelector('#avgHot').parentElement.style.left = avgHotPos + '%';
            }

            // Position house icon between average cold and average hot when available
            const housePos = hasCooling ? (avgColdPos + avgHotPos) / 2 : avgColdPos;
            document.getElementById('houseIcon').style.left = housePos + '%';
        }

        function calculateHVACCosts() {
            const hdd = climateData.hdd;
            const heatingDesign = climateData.heating;

            const electricityRate = parseFloat(document.getElementById('electricityRate').value) || 0.12;
            const gasRate = parseFloat(document.getElementById('gasRate').value) || 1.20;
            const heatPumpCOP = parseFloat(document.getElementById('heatPumpCOP').value) || 3.5;
            const furnaceEfficiency = parseFloat(document.getElementById('furnaceEfficiency').value) || 95;
            const crossoverTemp = parseFloat(document.getElementById('crossoverTemp').value) || 35;

            const systems = {
                heatPump: {
                    name: 'Heat Pump System',
                    cop: heatPumpCOP
                },
                furnace: {
                    name: 'Furnace System',
                    furnaceAFUE: furnaceEfficiency / 100
                },
                hybrid: {
                    name: 'Hybrid System',
                    cop: heatPumpCOP,
                    furnaceAFUE: furnaceEfficiency / 100
                }
            };

            const results = {};
            
            for (const [systemType, specs] of Object.entries(systems)) {
                const costs = calculateSystemCosts(systemType, specs, hdd, 0, heatingDesign, 0, electricityRate, gasRate, crossoverTemp);
                results[systemType] = costs;
            }

            maxCost = Math.max(results.heatPump.total, results.furnace.total, results.hybrid.total);
            displayCostBars(results);
            displaySystemResults(results);
            showWinner(results);
            updateTechnicalDetails(results, hdd, 0, heatingDesign, 0, electricityRate, gasRate, heatPumpCOP, furnaceEfficiency, crossoverTemp);

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('hybridSplit').style.display = 'block';
        }

        function calculateSystemCosts(systemType, specs, hdd, cdd, heatingDesign, coolingDesign, electricityRate, gasRate, crossoverTemp) {
            let annualHeatingCost = 0;
            let annualCoolingCost = 0;

            // Design loads (use actual user input)
            const designHeatingLoad = houseLoads.heating || 50000; // BTU/hr from user input
            const designCoolingLoad = houseLoads.cooling || 40000; // BTU/hr from user input
            
            // Indoor design temperature (standard for degree day calculations)
            const indoorTemp = 65; // °F (standard indoor temp for HDD/CDD calculations)
            const heatingDesignDiff = indoorTemp - heatingDesign; // Temperature difference for heating
            const coolingDesignDiff = coolingDesign - indoorTemp; // Temperature difference for cooling
            
            // Calculate heat loss rate (BTU/hr/°F) from design load
            // Design load = heat loss rate × design temp difference
            const heatLossRate = designHeatingLoad / heatingDesignDiff; // BTU/hr/°F
            const coolGainRate = designCoolingLoad / coolingDesignDiff; // BTU/hr/°F
            
            // Calculate annual energy using proper degree day method
            // Annual Energy = Heat Loss Rate × HDD × 24 hours
            const annualHeatingLoad = heatLossRate * hdd * 24; // Total BTU/year
            const annualCoolingLoad = coolGainRate * cdd * 24; // Total BTU/year
            
            // Debug the calculation
            console.log('Annual Load Calculation:');
            console.log('Design Heating Load:', designHeatingLoad, 'BTU/hr');
            console.log('Heating Design Diff:', heatingDesignDiff, '°F');
            console.log('Heat Loss Rate:', heatLossRate, 'BTU/hr/°F');
            console.log('HDD:', hdd);
            console.log('Annual Heating Load:', annualHeatingLoad, 'BTU/year');

            let annualTherms = 0;
            let annualKWh = 0;

            if (systemType === 'furnace') {
                // Gas furnace heating
                const heatingTherms = annualHeatingLoad / (100000 * specs.furnaceAFUE); // 100,000 BTU/therm
                annualHeatingCost = heatingTherms * gasRate;
                annualCoolingCost = 0; // No cooling
                annualTherms = heatingTherms;

            } else if (systemType === 'heatPump') {
                // Heat pump heating - Use COP for heating efficiency
                const heatingkWh = annualHeatingLoad / (specs.cop * 3412); // COP×3412 BTU per kWh
                annualHeatingCost = heatingkWh * electricityRate;
                annualCoolingCost = 0; // No cooling
                annualKWh = heatingkWh;
                console.log('Heat pump debug:', {
                    annualHeatingLoad,
                    cop: specs.cop,
                    heatingkWh,
                    electricityRate,
                    annualHeatingCost
                });

            } else if (systemType === 'hybrid') {
                // Use user-specified crossover temperature
                const xover = Number.isFinite(crossoverTemp) ? crossoverTemp : 35;
                
                // Calculate what percentage of heating degree days are above/below crossover
                let heatPumpPercentage;
                if (heatingDesign > xover) {
                    heatPumpPercentage = 1.0; // Always use heat pump
                } else if (heatingDesign > (xover - 15)) {
                    heatPumpPercentage = 0.7; // Mostly heat pump
                } else if (heatingDesign > (xover - 25)) {
                    heatPumpPercentage = 0.5; // Split operation
                } else {
                    heatPumpPercentage = 0.3; // Mostly gas backup
                }
                
                // Split the heating load
                const heatPumpHeatingLoad = annualHeatingLoad * heatPumpPercentage;
                const gasHeatingLoad = annualHeatingLoad * (1 - heatPumpPercentage);
                
                // Calculate costs for each portion
                const heatPumpkWh = heatPumpHeatingLoad / (specs.cop * 3412); // COP×3412 BTU per kWh
                const gasHeatingTherms = gasHeatingLoad / (100000 * specs.furnaceAFUE);
                
                annualHeatingCost = (heatPumpkWh * electricityRate) + (gasHeatingTherms * gasRate);
                annualCoolingCost = 0; // No cooling
                annualKWh = heatPumpkWh;
                annualTherms = gasHeatingTherms;
            }

            const annualEnergyCost = annualHeatingCost + annualCoolingCost;

            return {
                install: 0, // No installation cost in this calculation
                energy: Math.round(annualEnergyCost),
                maintenance: 0, // No maintenance cost in this calculation
                total: Math.round(annualEnergyCost),
                annualTherms,
                annualKWh
            };
        }

        function calculateHeatPumpEfficiency(heatingDesign, crossoverTemp) {
            // Heat pump efficiency drops significantly below crossover temperature
            if (heatingDesign > crossoverTemp) return 1.0;  // Above crossover: 100% efficient
            if (heatingDesign > crossoverTemp - 5) return 0.95;  // 5°F below: 95% efficient
            if (heatingDesign > crossoverTemp - 15) return 0.8;  // 15°F below: 80% efficient
            if (heatingDesign > crossoverTemp - 25) return 0.6;  // 25°F below: 60% efficient
            if (heatingDesign > crossoverTemp - 35) return 0.3;  // 35°F below: 30% efficient
            return 0.1;  // Very cold: 10% efficient (basically unusable)
        }

        function calculateCrossoverTemperature(heatingDesign) {
            // Crossover temperature is typically 35°F for most heat pumps
            // Below this temperature, heat pump efficiency drops significantly
            return 35;
        }

        function displayCostBars(results) {
            // Update the cost amounts in the boxes
            document.getElementById('heatPumpTotal').textContent = `$${Math.round(results.heatPump.total)}`;
            document.getElementById('furnaceTotal').textContent = `$${Math.round(results.furnace.total)}`;
            document.getElementById('hybridTotal').textContent = `$${Math.round(results.hybrid.total)}`;

            // Find the lowest cost
            const costs = [
                { type: 'heatPump', cost: results.heatPump.total },
                { type: 'furnace', cost: results.furnace.total },
                { type: 'hybrid', cost: results.hybrid.total }
            ];
            
            const lowestCost = Math.min(...costs.map(c => c.cost));
            const lowestType = costs.find(c => c.cost === lowestCost).type;

            // Remove 'lowest' class from all boxes
            document.getElementById('heatPumpBox').classList.remove('lowest');
            document.getElementById('furnaceBox').classList.remove('lowest');
            document.getElementById('hybridBox').classList.remove('lowest');

            // Add 'lowest' class to the cheapest option
            document.getElementById(lowestType + 'Box').classList.add('lowest');
        }

        function displaySystemResults(results) {
            const systems = ['heatPump', 'furnace', 'hybrid'];
            
            systems.forEach(system => {
                document.getElementById(system + 'Total').textContent = '$' + results[system].total.toLocaleString();
            });

            // Emissions (toggle)
            const showEm = document.getElementById('includeEmissions')?.checked;
            const gasMtPerTherm = 0.0053; // metric tons CO2/therm (EPA combustion)
            const elecMtPerKWh = 0.000394; // metric tons CO2/kWh (eGRID delivered avg)

            const setEm = (idBase, therms, kwh) => {
                const el = document.getElementById(idBase + 'Emissions');
                if (!el) return;
                if (!showEm) {
                    el.style.display = 'none';
                    ['hp','furnace','hybrid'].forEach(key => {
                        const r1 = document.getElementById(key + 'CoalRow1');
                        const r2 = document.getElementById(key + 'CoalRow2');
                        if (r1) r1.innerHTML = '';
                        if (r2) r2.innerHTML = '';
                    });
                    const bars = document.getElementById('emissionsBars');
                    if (bars) bars.style.display = 'none';
                    return;
                }
                const mt = (therms * gasMtPerTherm) + (kwh * elecMtPerKWh);
                const lbs = mt * 2204.62;
                el.textContent = 'CO2: ' + (Math.round(mt*100)/100) + ' t' + ' (' + Math.round(lbs).toLocaleString() + ' lbs)';
                el.style.display = 'block';
                // Coal bar: normalize against 80% furnace baseline
                const baselineTherms = (houseLoads.heating / (65 - climateData.heating)) * (climateData.hdd * 24) / (100000 * 0.80);
                const baselineMt = baselineTherms * gasMtPerTherm;
                const ratio = baselineMt > 0 ? Math.min(1, mt / baselineMt) : 0;
                const maxLumps = 24; // two rows of 12 for compact width
                const lumps = Math.round(ratio * maxLumps);
                const row1 = document.getElementById(idBase + 'CoalRow1');
                const row2 = document.getElementById(idBase + 'CoalRow2');
                if (row1 && row2) {
                    row1.innerHTML = '';
                    row2.innerHTML = '';
                    let remaining = lumps;
                    for (let col = 0; col < 12; col++) {
                        // Fill top then bottom for each column, left to right
                        if (remaining > 0) {
                            row1.appendChild(Object.assign(document.createElement('div'), { className: 'coal-lump' }));
                            remaining--;
                        } else {
                            row1.appendChild(Object.assign(document.createElement('div'), { className: 'coal-lump empty' }));
                        }
                        if (remaining > 0) {
                            row2.appendChild(Object.assign(document.createElement('div'), { className: 'coal-lump' }));
                            remaining--;
                        } else {
                            row2.appendChild(Object.assign(document.createElement('div'), { className: 'coal-lump empty' }));
                        }
                    }
                    const bars = document.getElementById('emissionsBars');
                    if (bars) bars.style.display = 'block';
                }
            };

            setEm('hp', results.heatPump.annualTherms||0, results.heatPump.annualKWh||0);
            setEm('furnace', results.furnace.annualTherms||0, results.furnace.annualKWh||0);
            setEm('hybrid', results.hybrid.annualTherms||0, results.hybrid.annualKWh||0);
        }

        function showWinner(results) {
            const costs = Object.values(results).map(r => r.total);
            const minCost = Math.min(...costs);
            
            let winner = 'heatPump';
            for (const [systemType, result] of Object.entries(results)) {
                if (result.total === minCost) {
                    winner = systemType;
                    break;
                }
            }

            // Remove existing lowest classes
            document.querySelectorAll('.cost-box').forEach(box => box.classList.remove('lowest'));
            
            // Add winner class to the winning box (CSS handles the "LOWEST RUN COST" badge)
            const winnerBox = document.getElementById(winner + 'Box');
            if (winnerBox) {
                winnerBox.classList.add('lowest');
            }
        }

        function showLoading() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('lookupBtn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('lookupBtn').disabled = false;
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorSection');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorSection').style.display = 'none';
        }

        function hideResults() {
            document.getElementById('locationInfo').style.display = 'none';
            // Don't hide temperature bar or results section - keep them visible
        }

        // Event listeners
        document.getElementById('zipCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                lookupClimateData();
            }
        });

        // Recalculate when inputs change
        document.getElementById('electricityRate').addEventListener('input', recalculateIfDataAvailable);
        document.getElementById('gasRate').addEventListener('input', recalculateIfDataAvailable);
        document.getElementById('heatPumpCOP').addEventListener('input', recalculateIfDataAvailable);
        document.getElementById('furnaceEfficiency').addEventListener('input', recalculateIfDataAvailable);
        document.getElementById('crossoverTemp').addEventListener('input', recalculateIfDataAvailable);

        function recalculateIfDataAvailable() {
            if (climateData) {
                calculateHVACCosts();
            }
        }

        function toggleTechnicalInfo() {
            const techInfo = document.getElementById('technicalInfo');
            const toggleText = document.getElementById('techToggleText');
            const toggleIcon = document.getElementById('techToggleIcon');
            
            if (techInfo.style.display === 'none') {
                techInfo.style.display = 'block';
                toggleText.textContent = 'Hide Technical Details';
                toggleIcon.textContent = '▲';
            } else {
                techInfo.style.display = 'none';
                toggleText.textContent = 'Show Technical Details';
                toggleIcon.textContent = '▼';
            }
        }

        // JS tooltip to avoid covering inputs or going off-screen
        (function() {
            const body = document.body;
            body.classList.add('js-tooltips-active');
            let bubble;
            let hideTimer;
            function showBubble(target) {
                const text = target.getAttribute('data-tooltip');
                if (!text) return;
                if (!bubble) {
                    bubble = document.createElement('div');
                    bubble.className = 'tooltip-bubble';
                    document.body.appendChild(bubble);
                }
                bubble.className = 'tooltip-bubble' + (target.id === 'heatPumpCOP' || target.getAttribute('for') === 'heatPumpCOP' ? ' theme-accent' : '');
                // Convert escaped newlines in data attributes ("\n") into real breaks
                bubble.innerHTML = String(text)
                    .replace(/\\n\\n/g, '<br><br>')
                    .replace(/\\n/g, '<br>');
                // Position to the side that fits best
                const row = target.closest('.input-row');
                const rect = row ? row.getBoundingClientRect() : target.getBoundingClientRect();
                const padding = 12;
                const prefRightX = rect.right + padding;
                const prefLeftX = rect.left - padding;
                const topY = Math.max(12, rect.top);
                bubble.style.visibility = 'hidden';
                bubble.style.left = '0px';
                bubble.style.top = '0px';
                bubble.style.display = 'block';
                const bw = bubble.offsetWidth;
                const bh = bubble.offsetHeight;
                const vw = window.innerWidth;
                const vh = window.innerHeight;
                let x, y;
                // Prefer left or right of the entire row to avoid covering either label or field.
                if (target.classList.contains('tooltip-left')) {
                    x = Math.max(12, Math.min(vw - bw - 12, rect.left - padding - bw));
                    y = Math.max(12, Math.min(vh - bh - 12, rect.top + (rect.height - bh)/2));
                } else if (target.classList.contains('tooltip-right')) {
                    x = Math.max(12, Math.min(vw - bw - 12, rect.right + padding));
                    y = Math.max(12, Math.min(vh - bh - 12, rect.top + (rect.height - bh)/2));
                } else if (target.classList.contains('tooltip-below')) {
                    // Place below the entire control-group to avoid covering label/input
                    const group = target.closest('.control-group');
                    const grect = group ? group.getBoundingClientRect() : rect;
                    y = Math.max(12, Math.min(vh - bh - 12, grect.bottom + padding));
                    x = Math.max(12, Math.min(vw - bw - 12, grect.left + (grect.width - bw)/2));
                } else {
                    // Fallback: above/below then center horizontally
                    const belowY = rect.bottom + padding;
                    const aboveY = rect.top - padding - bh;
                    const canBelow = belowY + bh <= vh;
                    const canAbove = aboveY >= 0;
                    if (canBelow) {
                        y = belowY;
                    } else if (canAbove) {
                        y = aboveY;
                    } else {
                        y = Math.max(12, Math.min(vh - bh - 12, rect.top + rect.height + padding));
                    }
                    if (prefRightX + bw <= vw) {
                        x = prefRightX;
                    } else if (prefLeftX - bw >= 0) {
                        x = prefLeftX - bw;
                    } else {
                        x = Math.max(12, Math.min(vw - bw - 12, rect.left + (rect.width - bw)/2));
                    }
                }
                bubble.style.left = x + 'px';
                bubble.style.top = y + 'px';
                bubble.style.visibility = 'visible';
            }
            function hideBubble() {
                if (bubble) bubble.style.display = 'none';
            }
            document.addEventListener('mouseenter', function(e) {
                const t = e.target.closest('[data-tooltip]');
                if (t) {
                    if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
                    showBubble(t);
                }
            }, true);
            document.addEventListener('mouseleave', function(e) {
                const t = e.target.closest('[data-tooltip]');
                if (t) {
                    hideTimer = setTimeout(() => hideBubble(), 200);
                }
            }, true);
        })();

        function updateTechnicalDetails(results, hdd, cdd, heatingDesign, coolingDesign, electricityRate, gasRate, heatPumpCOP, furnaceEfficiency, crossoverTemp) {
            // House specifications
            document.getElementById('houseSize').textContent = '2,000 sq ft';
            document.getElementById('heatingLoadFactor').textContent = '1.2 BTU/sq ft/HDD';
            const clf = document.getElementById('coolingLoadFactor');
            if (clf) clf.parentElement.style.display = 'none';

            // Climate data
            document.getElementById('hddValue').textContent = hdd.toLocaleString();
            const cddEl = document.getElementById('cddValue');
            if (cddEl) cddEl.parentElement.style.display = 'none';
            document.getElementById('heatingDesignValue').textContent = heatingDesign + '°F';
            const cdv = document.getElementById('coolingDesignValue');
            if (cdv) cdv.parentElement.style.display = 'none';

            // Energy calculations
            const houseSize = 2000;
            const heatingLoadFactor = 1.2;
            const totalHeatingBTU = hdd * houseSize * heatingLoadFactor;
            
            document.getElementById('totalHeatingBTU').textContent = totalHeatingBTU.toLocaleString() + ' BTU';
            const tcb = document.getElementById('totalCoolingBTU');
            if (tcb) tcb.parentElement.style.display = 'none';
            document.getElementById('electricityRateValue').textContent = '$' + electricityRate + '/kWh';
            document.getElementById('gasRateValue').textContent = '$' + gasRate + '/therm';

            // System performance details
            document.getElementById('heatPumpCOPValue').textContent = heatPumpCOP;
            document.getElementById('furnaceAFUEValue').textContent = furnaceEfficiency + '%';
            const xoverEl = document.getElementById('crossoverTempValue');
            if (xoverEl) xoverEl.textContent = crossoverTemp + '°F';

            // Totals 5/10/15 years
            const years = [5,10,15];
            const furnace = results.furnace;
            const hp = results.heatPump;
            const hybrid = results.hybrid;
            const tech = document.getElementById('technicalInfo');
            if (tech) {
                const existing = tech.querySelector('#miniCharts');
                if (existing) existing.remove();
                const wrap = document.createElement('div');
                wrap.id = 'miniCharts';
                wrap.className = 'tech-group';
                wrap.innerHTML = '<h5>Multi-Year Totals</h5>' +
                    '<div class="mini-charts">' +
                    '<div class="mini-chart" id="costChart"><h6>Run Cost Totals</h6><div class="mini-chart-body"></div></div>' +
                    '<div class="mini-chart" id="co2Chart"><h6>CO2 Totals (metric tons)</h6><div class="mini-chart-body"></div></div>' +
                    '</div>';
                tech.appendChild(wrap);

                const build = (mountId, groups, formatter) => {
                    const mount = wrap.querySelector('#' + mountId);
                    const body = mount.querySelector('.mini-chart-body');
                    body.innerHTML = '';
                    groups.forEach(g => {
                        const gEl = document.createElement('div');
                        gEl.className = 'mini-group';
                        const barsWrap = document.createElement('div');
                        barsWrap.className = 'mini-bars';
                        years.forEach((y, idx) => {
                            const v = g.values[y];
                            const bar = document.createElement('div');
                            bar.className = 'mini-bar year' + y + ' ' + g.className;
                            const max = Math.max(...groups.flatMap(gr => years.map(k=>gr.values[k])));
                            const h = max > 0 ? Math.max(2, Math.round((v / max) * 140)) : 2;
                            bar.style.height = h + 'px';
                            bar.setAttribute('data-value', formatter(v));
                            barsWrap.appendChild(bar);
                        });
                        gEl.appendChild(barsWrap);
                        const lab = document.createElement('div');
                        lab.className = 'mini-label';
                        lab.textContent = g.label;
                        gEl.appendChild(lab);
                        body.appendChild(gEl);
                    });
                };

                build('costChart', [
                    { label: 'Heat Pump', className: 'color-heatpump', values: {5:hp.total*5,10:hp.total*10,15:hp.total*15} },
                    { label: 'Furnace', className: 'color-furnace', values: {5:furnace.total*5,10:furnace.total*10,15:furnace.total*15} },
                    { label: 'Hybrid', className: 'color-hybrid', values: {5:hybrid.total*5,10:hybrid.total*10,15:hybrid.total*15} }
                ], v => '$' + Math.round(v).toLocaleString());

                build('co2Chart', [
                    { label: 'Heat Pump', className: 'color-heatpump', values: {5:hp.annualKWh*0.000394*5,10:hp.annualKWh*0.000394*10,15:hp.annualKWh*0.000394*15} },
                    { label: 'Furnace', className: 'color-furnace', values: {5:furnace.annualTherms*0.0053*5,10:furnace.annualTherms*0.0053*10,15:furnace.annualTherms*0.0053*15} },
                    { label: 'Hybrid', className: 'color-hybrid', values: {5:(hybrid.annualTherms*0.0053+hybrid.annualKWh*0.000394)*5,10:(hybrid.annualTherms*0.0053+hybrid.annualKWh*0.000394)*10,15:(hybrid.annualTherms*0.0053+hybrid.annualKWh*0.000394)*15} }
                ], v => (Math.round(v*100)/100).toString());
            }

            // Calculate efficiencies
            const heatPumpHeatingEff = (heatPumpCOP * 3.412).toFixed(1) + '%';
            const furnaceHeatingEff = furnaceEfficiency + '%';

            document.getElementById('heatPumpHeatingEff').textContent = heatPumpHeatingEff;
            document.getElementById('furnaceHeatingEff').textContent = furnaceHeatingEff;
            const hpce = document.getElementById('heatPumpCoolingEff');
            if (hpce) hpce.parentElement.style.display = 'none';
            const fce = document.getElementById('furnaceCoolingEff');
            if (fce) fce.parentElement.style.display = 'none';

            // Hybrid system details
            const heatPumpEfficiency = calculateHeatPumpEfficiency(heatingDesign, crossoverTemp);
            const heatPumpUsage = (heatPumpEfficiency * 100).toFixed(0) + '%';
            const furnaceUsage = ((1 - heatPumpEfficiency) * 100).toFixed(0) + '%';
            
            document.getElementById('crossoverTemp').textContent = crossoverTemp + '°F';
            document.getElementById('hybridHeatPumpUsage').textContent = heatPumpUsage;
            document.getElementById('hybridFurnaceUsage').textContent = furnaceUsage;
            document.getElementById('hybridHeatingEff').textContent = 'Mixed (see above)';
            const hce = document.getElementById('hybridCoolingEff');
            if (hce) hce.parentElement.style.display = 'none';

            // Update usage bar
            updateUsageBar(heatPumpEfficiency, heatingDesign, crossoverTemp);
        }

        function updateUsageBar(heatPumpEfficiency, heatingDesign, crossoverTemp) {
            const heatPumpPercentage = (heatPumpEfficiency * 100).toFixed(0);
            const furnacePercentage = ((1 - heatPumpEfficiency) * 100).toFixed(0);
            
            // Update bar segments
            document.getElementById('heatPumpSegment').style.width = heatPumpPercentage + '%';
            document.getElementById('furnaceSegment').style.width = furnacePercentage + '%';
            
            // Update percentage labels
            document.getElementById('heatPumpPercentage').textContent = heatPumpPercentage + '%';
            document.getElementById('furnacePercentage').textContent = furnacePercentage + '%';
            
            // Update explanation
            const explanation = `Heat pump handles heating above ${crossoverTemp}°F (${heatPumpPercentage}% of heating load). Furnace handles heating below ${crossoverTemp}°F (${furnacePercentage}% of heating load).`;
            document.getElementById('usageExplanation').textContent = explanation;
        }
    </script>
</body>
</html>
</html>
</html>
</html>